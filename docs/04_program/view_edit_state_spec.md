# View/Edit状態仕様（最終完全FIX）

## 1. 対象

- `detail.php?id={id}`
- 詳細表示と編集を **同一画面でDOM切替**

---

# 2. 状態定義

| 状態 | 説明 |
| --- | --- |
| View | 表示専用状態（初期状態） |
| Edit | 編集可能状態（フォーム表示） |

状態は **クライアント側（DOM制御）で管理**する。

サーバに edit フラグは持たない。

---

# 3. 初期表示

- `detail.php` を開いた直後は **必ず View状態**
- 表示値は DB保存値

---

# 4. 状態遷移

## 4-1. Editボタン押下（View → Edit）

- View表示を非表示
- Editフォームを表示
- フォーム初期値は現在のDB値

サーバ通信なし

---

## 4-2. Cancel押下（Edit → View）

- Editフォームを非表示
- View表示を再表示
- 入力内容は破棄
- DB値に戻る

サーバ通信なし

---

## 4-3. Save押下（Edit → 更新処理）

1. POST送信
2. サーバでバリデーション
3. 更新処理実行

---

# 5. 更新後の表示ルール（PRG適用）

## 5-1. 更新成功

1. 更新完了
2. `detail.php?id={id}` にリダイレクト（GET）
3. 画面は **View状態で表示**
4. 表示値は更新後のDB値

※ F5しても再POSTされない

---

## 5-2. 更新失敗（バリデーションエラー）

- リダイレクトしない
- 同一リクエストで detail.php 再描画
- 画面は **Edit状態**
- 入力値はユーザー入力を保持
- エラーを画面上部に表示（ul形式）

---

# 6. UI側整合補助

- `is_resolved = 0` のとき
    
    → `is_knowledge` を操作不可にする（任意）
    

※ ただし最終判定はサーバ側で必ず行う

---

# 7. 更新可能項目

| 項目 | 更新可 |
| --- | --- |
| occurred_at | ❌（表示のみ） |
| language | ⭕ |
| level | ⭕ |
| title | ⭕ |
| message | ⭕ |
| solution | ⭕ |
| is_resolved | ⭕ |
| is_knowledge | ⭕ |

---

# 8. 不正ID時の扱い

以下の場合は **404相当表示**

- id未指定
- idが整数でない
- idが0以下
- 該当レコードなし

Edit状態には入らない

---

# 9. 成功メッセージ（任意）

- 更新成功後に View状態で表示可能
- 必須ではない（MVPでは省略可）

---

## 設計ポイントまとめ

- DOM切替はクライアントのみ
- 更新処理は必ずサーバ通信
- 成功時はPRGでViewに戻す
- 失敗時はEditで保持
- 整合性は最終的にサーバで保証